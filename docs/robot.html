<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>robot.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>robot.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">recovery</span> <span class="kn">import</span> <span class="n">Recovery</span>
<span class="kn">from</span> <span class="nn">identifier</span> <span class="kn">import</span> <span class="n">Identifier</span><span class="p">,</span> <span class="n">Blob</span>
<span class="kn">from</span> <span class="nn">predictor</span> <span class="kn">import</span> <span class="n">Predictor</span>
<span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">Metrics</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">Odometry</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Bool</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">LaserScan</span>

<span class="n">PI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">SIMULATION_TIME</span> <span class="o">=</span> <span class="mi">100</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>This is responsible for the overall behaviour of the robot and integration with different components</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Robot</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">DEBUG_CHASE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">DEBUG_RECOVERY</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">CMD_FREQ</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Hz</span>
    <span class="n">SLEEP</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># secs</span>
    <span class="n">VEL</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># m/s</span>

    <span class="n">START_X_MAP</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># Would change as per the map</span>
    <span class="n">START_Y_MAP</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Would change as per the map</span>
    <span class="n">START_YAW_MAP</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Would change as per the map</span>

    <span class="n">KP</span> <span class="o">=</span> <span class="mf">0.5</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Initialize all instance vars and publishers/subscribers/listeners for processing &amp; following target</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s2">&quot;robot&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>continually updated info about robot&rsquo;s pose wrt odom</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">posx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posy</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_posx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_posy</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span> <span class="o">=</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>useful transformation matrices for movement</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">odom_to_map_array</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Robot</span><span class="o">.</span><span class="n">START_X_MAP</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Robot</span><span class="o">.</span><span class="n">START_Y_MAP</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>  <span class="c1"># odom to map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mTo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">odom_to_map_array</span><span class="p">)</span>  <span class="c1"># recovery uses this object type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans_odom_to_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">odom_to_map_array</span><span class="p">)</span>  <span class="c1"># identifier uses this object type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bTo</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># odom to base_link; updated in call back</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all poses to move to in order to get to last detected target pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># initialize in move() to avoid null problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Identifier</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="n">Predictor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_last_scan</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_ever_found</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;robot_0/cmd_vel&quot;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;visible_status&quot;</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># latest one only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odom_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;robot_0/odom&quot;</span><span class="p">,</span> <span class="n">Odometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odom_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_laser</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;robot_0/base_scan&quot;</span><span class="p">,</span> <span class="n">LaserScan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">laser_scan_callback</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lis</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TransformListener</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">Robot</span><span class="o">.</span><span class="n">SLEEP</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Update instance variables with latest odom info
@param msg: odom topic message</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">odom_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>getting all of the odom information on the current pose of the robot</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">posx</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posy</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>from https://answers.ros.org/question/11545/plotprint-rpy-from-quaternion/#17106</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">euler_from_quaternion</span><span class="p">(</span>
            <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
             <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">yaw</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Helper function for publishing whether target is visible to robot
@param visible: boolean indicates whether target is visible</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pub_visibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visible</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">msg</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">visible</span>  <span class="c1"># expect boolean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Callback function to get the latest odom to base_link transformation; CALL BEFORE USING self.bTo</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>get transformation from odom to base_link</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lis</span><span class="o">.</span><span class="n">lookupTransform</span><span class="p">(</span><span class="s1">&#39;robot_0/base_link&#39;</span><span class="p">,</span> <span class="s1">&#39;robot_0/odom&#39;</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>get everything in regular matrix form</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">translation_matrix</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">quaternion_matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bTo</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Uses laser scan to update target position
@param laser_scan_msg: laser scan message with obstacle info</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">laser_scan_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser_scan_msg</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">curr_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_last_scan</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_last_scan</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">SCAN_FREQ</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_posx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">blobify</span><span class="p">(</span><span class="n">laser_scan_msg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># Identify blobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_movement_transform</span><span class="p">())</span>  <span class="c1"># Classify blobs, set target</span>
                <span class="n">tpos</span><span class="p">,</span> <span class="n">tvel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">get_target_pos_vel</span><span class="p">(</span><span class="n">robot</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;MAP&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_target_status</span><span class="p">(</span><span class="n">tpos</span><span class="p">,</span> <span class="n">tvel</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">update_targetpos</span><span class="p">(</span>
                    <span class="bp">None</span> <span class="k">if</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">None</span> <span class="k">if</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">None</span> <span class="k">if</span> <span class="n">tvel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">tvel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">None</span> <span class="k">if</span> <span class="n">tvel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">tvel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Update last pose to current</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">last_posx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_posy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_last_scan</span> <span class="o">=</span> <span class="n">curr_time</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Helper function to update Recovery object with necessary info before calling A* search</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_rcvr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>update recovery with robot&rsquo;s current pose</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span>  <span class="c1"># update self.bTo first</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">posx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">robot_pos</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">robot_pos</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">robot_pos</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">robot_ang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">+</span> <span class="n">Robot</span><span class="o">.</span><span class="n">START_YAW_MAP</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">blobifying</span><span class="p">:</span>  <span class="c1"># dict size may change while this flag is true</span>
            <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>update local map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">blobs_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">blobs</span><span class="p">)</span>  <span class="c1"># avoid dict size changing while looping below</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># blob_id:blob_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span>  <span class="c1"># update again</span>
        <span class="k">for</span> <span class="n">blob_id</span> <span class="ow">in</span> <span class="n">blobs_cp</span><span class="p">:</span>
            <span class="n">blobs</span><span class="p">[</span><span class="n">blob_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Blob</span><span class="p">(</span><span class="n">blob_id</span><span class="p">)</span>
            <span class="n">blobs</span><span class="p">[</span><span class="n">blob_id</span><span class="p">]</span><span class="o">.</span><span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">blobs_cp</span><span class="p">[</span><span class="n">blob_id</span><span class="p">]</span><span class="o">.</span><span class="n">arr</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bTo</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">blobs</span><span class="p">[</span><span class="n">blob_id</span><span class="p">]</span><span class="o">.</span><span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">create_local_world</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Pretty prints target position and velocity in map frame
@param tpos: Target position
@param tvel: Target velocity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">display_target_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpos</span><span class="p">,</span> <span class="n">tvel</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ever_found</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">print</span> <span class="s2">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;-&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]))</span>
        <span class="k">if</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Target Pos      : ({},{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">tpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">tpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">tvel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Target Vel      : ({},{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">tvel</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">tvel</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Target Lost&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Calls other functions to determine the velocities to publish</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span> <span class="o">=</span> <span class="n">Recovery</span><span class="p">()</span>

        <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Rate</span><span class="p">(</span><span class="n">Robot</span><span class="o">.</span><span class="n">CMD_FREQ</span><span class="p">)</span>
        <span class="n">vel_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
        <span class="k">print</span> <span class="s2">&quot;Searching for target...&quot;</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>only run for certain time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">SIMULATION_TIME</span><span class="p">:</span>

            <span class="n">lin_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ang_z</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">tpos</span><span class="p">,</span> <span class="n">tvel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">get_target_pos_vel</span><span class="p">(</span><span class="n">robot</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;MAP&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_ever_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ever_found</span> <span class="ow">or</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>we detect target so decide how to move using PID-like function</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">tpos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tvel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pub_visibility</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># can see the target</span>
                <span class="n">lin_x</span><span class="p">,</span> <span class="n">ang_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chase</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>recovery object will always have last known target pose to prepare for recovery mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">tpos_map</span><span class="p">,</span> <span class="n">tvel_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">get_target_pos_vel</span><span class="p">(</span><span class="n">robot</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;MAP&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">last_known_pos</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">last_known_pos</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">tpos_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">last_known_pos</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">tpos_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>clear poses for recovery when re-entering regular mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">elif</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">Identifier</span><span class="o">.</span><span class="n">ID_INIT_TIME</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pub_visibility</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ever_found</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pub_visibility</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>elif self.rcvr is not None:  # target is out of sight, go into recovery mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># target is out of sight, go into recovery mode</span>

                <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_RECOVERY</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;In Recovery : &quot;</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;({},{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pub_visibility</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># cant see the target</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>we delete as we go and clear when switch state so should be empty upon switch to RECOVERY</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="bp">self</span><span class="o">.</span><span class="n">update_rcvr</span><span class="p">()</span>  <span class="c1"># remember to update Recovery object&#39;s required info first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr</span><span class="o">.</span><span class="n">recover</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>print(&ldquo;retrieved rcvr_poses&rdquo;, self.rcvr_poses)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>in the middle of recovery mode
separate if statement so we don&rsquo;t have to wait until next loop iteration
to start moving once entered recovery mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_RECOVERY</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s2">&quot;goal in map frame: ({},{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                                                  <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>essentially we are moving to every position from a list that goes
 [goalx, goaly], &hellip;, <a href="goalx, goaly], ...html">startx, starty</a>, if we encounter target before we finish this list
i.e. state changes back to REGULAR, just clear list to prep for next recovery call</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>transform user-given point in odom to base_link, assume ROBOT CAN&rsquo;T FLY</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mTo</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pose</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bTo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># only need x,y because of assumption above</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>remaining angle to turn i.e. angle btwn x-axis vector and vector of x,y above</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="o">-</span><span class="mf">0.05</span> <span class="o">&lt;=</span> <span class="n">ang</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>turn finished so start moving in lin x only, if applicable</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">ang_z</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>remaining euclidean distance to travel, assume no movement in z-axis</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span>
                        <span class="k">if</span> <span class="o">-</span><span class="mf">0.05</span> <span class="o">&lt;=</span> <span class="n">dis</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>lin x move finished, pop this pose</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                            <span class="bp">self</span><span class="o">.</span><span class="n">rcvr_poses</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="k">continue</span>  <span class="c1"># no need to waste a publication</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lin_x</span> <span class="o">=</span> <span class="n">Robot</span><span class="o">.</span><span class="n">VEL</span>  <span class="c1"># rotation ensures we always move forward</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lin_x</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ang_z</span> <span class="o">=</span> <span class="o">-</span><span class="n">Robot</span><span class="o">.</span><span class="n">VEL</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># can only be positive, near 0 is rounded to 0 and handled above</span>
                            <span class="n">ang_z</span> <span class="o">=</span> <span class="n">Robot</span><span class="o">.</span><span class="n">VEL</span>

            <span class="n">vel_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">lin_x</span>
            <span class="n">vel_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ang_z</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span>
            <span class="n">rate</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Halt the target once simulation is elapsed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">vel_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vel_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>This guides the robot when the target is visible</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">chase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">lin_x</span> <span class="o">=</span> <span class="n">Robot</span><span class="o">.</span><span class="n">VEL</span>
        <span class="n">ang_z</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">target_angle_base</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">obs_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">obs_intervals</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>init chase angle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">chase_angle</span> <span class="o">=</span> <span class="n">target_angle_base</span>
        <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;target angle    : &quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">chase_angle</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Incorporate predicted robot position into chase angle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.04</span>
        <span class="n">lookahead</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">predict_hd</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">lookahead</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_pred_map</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_pred_base</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">map_to_base</span><span class="p">(</span><span class="n">last_pred_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_odom_to_map</span><span class="p">,</span>
                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;LAST_PRED_MAP   : ({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_pred_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last_pred_map</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;LAST_PRED_BAS   : ({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_pred_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last_pred_base</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">chase_angle</span> <span class="o">=</span> <span class="n">last_pred_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Predicted angle : &quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">chase_angle</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Incorporate obstacles into chase angle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">robot_width_angle</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">colliding_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_int</span> <span class="k">for</span> <span class="n">obs_int</span> <span class="ow">in</span> <span class="n">obs_intervals</span> <span class="k">if</span>
                         <span class="n">obs_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">robot_width_angle</span> <span class="o">&lt;=</span> <span class="n">chase_angle</span> <span class="o">&lt;=</span> <span class="n">obs_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">robot_width_angle</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colliding_obs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>colliding, use find tangent</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">min_ang_obs</span><span class="p">,</span> <span class="n">max_ang_obs</span> <span class="o">=</span> <span class="n">colliding_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">chase_angle</span> <span class="o">-</span> <span class="n">target_angle_base</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>print &ldquo;target is the obstacle&rdquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;obs             @ &lt;{}|{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">min_ang_obs</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">max_ang_obs</span><span class="p">))</span>
                <span class="n">go_min_side</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">chase_angle</span> <span class="o">-</span> <span class="n">min_ang_obs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">chase_angle</span> <span class="o">-</span> <span class="n">max_ang_obs</span><span class="p">)</span>
                <span class="n">tangent_angle</span> <span class="o">=</span> <span class="n">min_ang_obs</span> <span class="k">if</span> <span class="n">go_min_side</span> <span class="k">else</span> <span class="n">max_ang_obs</span>
                <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;tangent angle   : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">tangent_angle</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>Add wiggle room</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">wiggle_angle</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">go_min_side</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;wiggle angle    : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">wiggle_angle</span><span class="p">))</span>
                <span class="n">chase_angle</span> <span class="o">=</span> <span class="n">tangent_angle</span> <span class="o">+</span> <span class="n">wiggle_angle</span>
                <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;final angle     : &quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">chase_angle</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ang_z</span> <span class="o">=</span> <span class="n">chase_angle</span> <span class="o">*</span> <span class="n">Robot</span><span class="o">.</span><span class="n">KP</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Robot</span><span class="o">.</span><span class="n">DEBUG_CHASE</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;dist            : &quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">lin_x</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">(),</span> <span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lin_x</span><span class="p">,</span> <span class="n">ang_z</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>This returns the homogeneous transformation matrix between current and last robot pose</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_movement_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">sz1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">cz1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="n">cz1</span><span class="p">,</span> <span class="o">-</span><span class="n">sz1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posx</span><span class="p">],</span> <span class="p">[</span><span class="n">sz1</span><span class="p">,</span> <span class="n">cz1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">posy</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="n">sz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span><span class="p">)</span>
        <span class="n">cz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_angle</span><span class="p">)</span>
        <span class="n">mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="n">cz2</span><span class="p">,</span> <span class="o">-</span><span class="n">sz2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_posx</span><span class="p">],</span> <span class="p">[</span><span class="n">sz2</span><span class="p">,</span> <span class="n">cz2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_posy</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">mat2</span><span class="o">.</span><span class="n">getI</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Robot</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">move</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
